<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yiling.marketing.lotteryactivity.dao.LotteryActivityMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.yiling.marketing.lotteryactivity.entity.LotteryActivityDO">
    <result column="id" property="id" />
        <result column="activity_name" property="activityName" />
        <result column="start_time" property="startTime" />
        <result column="end_time" property="endTime" />
        <result column="category" property="category" />
        <result column="platform" property="platform"/>
        <result column="op_remark" property="opRemark" />
        <result column="budget_amount" property="budgetAmount" />
        <result column="bg_picture" property="bgPicture"/>
        <result column="status" property="status" />
        <result column="del_flag" property="delFlag" />
        <result column="create_user" property="createUser" />
        <result column="create_time" property="createTime" />
        <result column="update_user" property="updateUser" />
        <result column="update_time" property="updateTime" />
        <result column="remark" property="remark" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id,
        activity_name, start_time, end_time, category, platform, op_remark, budget_amount, bg_picture, status, del_flag, create_user, create_time, update_user, update_time, remark
    </sql>

    <select id="queryListPage" resultType="com.yiling.marketing.lotteryactivity.bo.LotteryActivityItemBO">
        select la.id, la.activity_name, la.start_time, la.end_time, la.category, la.op_remark, la.budget_amount, la.status,
            la.create_user, la.create_time, la.update_user, la.update_time, u.name as createUserName, u.mobile as mobile
        from marketing_lottery_activity la
        left join user u on la.create_user = u.id
        <if test="request.ename != null and request.ename !='' ">
            left join marketing_lottery_activity_join_detail lajd on la.id = lajd.lottery_activity_id and lajd.del_flag = 0
        </if>
        <where>
            la.del_flag = 0
            <if test="request.lotteryActivityId != null and request.lotteryActivityId != 0">
                and la.id = #{request.lotteryActivityId}
            </if>
            <if test="request.activityName != null and request.activityName != ''">
                and la.activity_name like concat('%',#{request.activityName},'%')
            </if>
            <if test="request.status != null and request.status != 0">
                and la.status = #{request.status}
            </if>
            <if test="request.status == null or request.status == 0">
                and la.status != 3
            </if>
            <if test="request.progress != null and request.progress != 0">
                <if test="request.progress == 1">
                    and la.start_time <![CDATA[ > ]]> now()
                </if>
                <if test="request.progress == 2">
                    and la.start_time <![CDATA[ <= ]]> now() and la.end_time <![CDATA[ > ]]> now() and la.status = 1
                </if>
                <if test="request.progress == 3">
                    and (la.end_time <![CDATA[ < ]]> now() or la.status = 2)
                </if>
            </if>
            <if test="request.neProgress != null and request.neProgress != 0">
                <if test="request.neProgress == 1">
                    and (la.start_time <![CDATA[ > ]]> now() or (la.start_time <![CDATA[ <= ]]> now() and la.end_time <![CDATA[ > ]]> now()) )
                </if>
                <if test="request.neProgress == 2">
                    and (la.start_time <![CDATA[ > ]]> now() or la.end_time <![CDATA[ < ]]> now() )
                </if>
                <if test="request.neProgress == 3">
                    and (la.start_time <![CDATA[ > ]]> now() or (la.start_time <![CDATA[ <= ]]> now() and la.end_time <![CDATA[ > ]]> now()) )
                </if>
            </if>
            <if test="request.ename != null and request.ename != ''">
                and lajd.uname = #{request.ename}
            </if>
            <if test="request.createUserName != null and request.createUserName != ''">
                and u.name like concat('%',#{request.createUserName},'%')
            </if>
            <if test="request.mobile != null and request.mobile != ''">
                and u.mobile like concat('%',#{request.mobile},'%')
            </if>
            <if test="request.startCreateTime != null">
                and la.start_time <![CDATA[ >= ]]> #{request.startCreateTime}
            </if>
            <if test="request.endCreateTime != null">
                and la.start_time <![CDATA[ <= ]]> #{request.endCreateTime}
            </if>
            <if test="request.category != null and request.category != 0">
                and la.category = #{request.category}
            </if>
            <if test="request.opRemark != null and request.opRemark != ''">
                and la.op_remark like concat('%',#{request.opRemark},'%')
            </if>
            <if test="request.platform != null and request.platform != 0">
                and la.platform = #{request.platform}
            </if>
            <if test="request.notInPlatformList != null and request.notInPlatformList.size > 0">
                and la.platform not in
                <foreach item="item" index="index" collection="request.notInPlatformList" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
        order by la.create_time desc

    </select>

</mapper>
