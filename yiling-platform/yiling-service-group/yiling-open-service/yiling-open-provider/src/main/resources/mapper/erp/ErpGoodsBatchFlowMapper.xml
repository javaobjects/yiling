<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yiling.open.erp.dao.ErpGoodsBatchFlowMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.yiling.open.erp.entity.ErpGoodsBatchFlowDO">
        <result column="id" property="id"/>
        <result column="gb_id_no" property="gbIdNo"/>
        <result column="gb_time" property="gbTime"/>
        <result column="in_sn" property="inSn"/>
        <result column="gb_batch_no" property="gbBatchNo"/>
        <result column="gb_produce_time" property="gbProduceTime"/>
        <result column="gb_end_time" property="gbEndTime"/>
        <result column="gb_produce_address" property="gbProduceAddress"/>
        <result column="gb_number" property="gbNumber"/>
        <result column="gb_name" property="gbName"/>
        <result column="gb_license" property="gbLicense"/>
        <result column="gb_specifications" property="gbSpecifications"/>
        <result column="gb_unit" property="gbUnit"/>
        <result column="gb_manufacturer" property="gbManufacturer"/>
        <result column="cnt" property="cnt"/>
        <result column="data_md5" property="dataMd5"/>
        <result column="add_time" property="addTime"/>
        <result column="edit_time" property="editTime"/>
        <result column="oper_type" property="operType"/>
        <result column="sync_status" property="syncStatus"/>
        <result column="sync_time" property="syncTime"/>
        <result column="sync_msg" property="syncMsg"/>
        <result column="failed_count" property="failedCount"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
      select  id,su_id,su_dept_no,
        gb_id_no, gb_time, in_sn, gb_batch_no, gb_produce_time, gb_end_time, gb_produce_address, gb_number, gb_name, gb_license, gb_specifications, gb_unit, gb_manufacturer, cnt, data_md5, add_time, edit_time, oper_type, sync_status, sync_time, sync_msg, failed_count
    </sql>

    <select id="queryBySuIdAndSuDeptNo" resultMap="BaseResultMap">
        SELECT id,su_id,su_dept_no,gb_id_no,data_md5,oper_type FROM erp_goods_batch_flow WHERE su_id = #{suId}
        <if test="suDeptNo != null and suDeptNo != ''">
            AND su_dept_no = #{suDeptNo}
        </if>
        LIMIT #{start},#{count}
    </select>

    <select id="queryHistoryList" resultMap="BaseResultMap">
        SELECT id,su_id,su_dept_no,gb_id_no,oper_type
        FROM erp_goods_batch_flow
        WHERE su_id = #{suId}
        <if test="suDeptNoSet != null and suDeptNoSet.size() > 0">
            AND su_dept_no IN
            <foreach item="item" index="index" collection="suDeptNoSet"
                     open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="erpPrimaryKeySet != null and erpPrimaryKeySet.size() > 0">
            AND gb_id_no IN
            <foreach item="item" index="index" collection="erpPrimaryKeySet"
                     open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </select>

    <insert id="batchInsert" parameterType="com.yiling.open.erp.entity.ErpGoodsBatchFlowDO" useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO erp_goods_batch_flow (
        `id`,
        `su_id`,
        `su_dept_no`,
        `gb_id_no`,
        `gb_time`,
        `in_sn`,
        `gb_batch_no`,
        `gb_produce_time`,
        `gb_end_time`,
        `gb_produce_address`,
        `gb_number`,
        `gb_name`,
        `gb_license`,
        `gb_specifications`,
        `gb_unit`,
        `gb_manufacturer`,
        `data_md5`,
        `add_time`,
        `oper_type`,
        `sync_status`,
        `sync_msg`,
        `failed_count`
        )
        VALUES
        <foreach collection="list" item="item" index="index"
                 separator=",">
            (
            #{item.id},
            #{item.suId},
            #{item.suDeptNo},
            #{item.gbIdNo},
            <if test="item.gbTime != null">
                #{item.gbTime},
            </if>
            <if test="item.gbTime == null">
                '1970-01-01 00:00:00',
            </if>
            #{item.inSn},
            #{item.gbBatchNo},
            <if test="item.gbProduceTime != null">
                #{item.gbProduceTime},
            </if>
            <if test="item.gbProduceTime == null">
                '1970-01-01 00:00:00',
            </if>
            <if test="item.gbEndTime != null">
                #{item.gbEndTime},
            </if>
            <if test="item.gbEndTime == null">
                '1970-01-01 00:00:00',
            </if>
            #{item.gbProduceAddress},
            #{item.gbNumber},
            #{item.gbName},
            #{item.gbLicense},
            #{item.gbSpecifications},
            #{item.gbUnit},
            #{item.gbManufacturer},
            #{item.dataMd5},
            NOW(),
            1,
            1,
            #{item.syncMsg},
            #{item.failedCount}
            )
        </foreach>
    </insert>

    <update id="updateByPrimaryKey" parameterType="com.yiling.open.erp.entity.ErpGoodsBatchFlowDO">
        UPDATE erp_goods_batch_flow
        SET
        <if test="suId != null">
            `su_id` = #{suId},
        </if>
        <if test="suDeptNo != null and suDeptNo != ''">
            `su_dept_no` = #{suDeptNo},
        </if>
        <if test="inSn != null and inSn != ''">
            `in_sn` = #{inSn},
        </if>
        <if test="gbBatchNo != null and gbBatchNo != ''">
            `gb_batch_no` = #{gbBatchNo},
        </if>
        <if test="gbTime != null">
            `gb_time` = #{gbTime},
        </if>
        <if test="gbProduceTime != null">
            `gb_produce_time` = #{gbProduceTime},
        </if>
        <if test="gbEndTime != null">
            `gb_end_time` = #{gbEndTime},
        </if>
        <if test="gbProduceAddress != null and gbProduceAddress != ''">
            `gb_produce_address` = #{gbProduceAddress},
        </if>
        <if test="gbNumber != null">
            `gb_number` = #{gbNumber},
        </if>
        <if test="gbName != null and gbName != ''">
            `gb_name` = #{gbName},
        </if>
        <if test="gbLicense != null and gbLicense != ''">
            `gb_license` = #{gbLicense},
        </if>
        <if test="gbSpecifications != null and gbSpecifications != ''">
            `gb_specifications` = #{gbSpecifications},
        </if>
        <if test="gbUnit != null and gbUnit != ''">
            `gb_unit` = #{gbUnit},
        </if>
        <if test="gbManufacturer != null and gbManufacturer != ''">
            `gb_manufacturer` = #{gbManufacturer},
        </if>
        <if test="dataMd5 != null and dataMd5 != ''">
            `data_md5` = #{dataMd5},
        </if>
        <if test="syncMsg != null and syncMsg != ''">
            `sync_msg` = #{syncMsg},
        </if>
        <if test="syncStatus != null">
            `sync_status` = #{syncStatus},
        </if>
        <if test="failedCount != null">
            `failed_count` = #{failedCount},
        </if>
        `edit_time` = NOW(),
        `failed_count` = 0,
        `oper_type` = 2
        WHERE id = #{id}
    </update>

    <update id="updateSyncInfoByPrimaryKey" parameterType="com.yiling.open.erp.entity.ErpGoodsBatchFlowDO">
		UPDATE erp_goods_batch_flow
		SET
		`sync_status` = #{syncStatus},
		`sync_msg` = #{syncMsg}
		WHERE id = #{id}
	</update>

    <update id="deleteByPrimaryKey" parameterType="com.yiling.open.erp.entity.ErpGoodsBatchFlowDO">
		UPDATE erp_goods_batch_flow
		SET
		`edit_time` = NOW(),
		`oper_type` = 3,
		`sync_status` = #{syncStatus},
		`sync_msg` = #{syncMsg}
		WHERE `id` = #{id}
		AND oper_type &lt; 3
	</update>

    <update id="deleteByPrimaryKeys">
        UPDATE erp_goods_batch_flow
        SET
        `edit_time` = NOW(),
        `oper_type` = 3,
        `sync_status` = 1,
        failed_count=0
        WHERE id IN
        <foreach item="item" index="index" collection="list" open="("
                 separator="," close=")">
            #{item}
        </foreach>
    </update>
    <!--=================================================================================================-->
    <update id="updateSyncStatusByStatusAndId">
        update
        `erp_goods_batch_flow` set
        `sync_status`=#{syncStatus},`sync_time`=Now(),`sync_msg` = #{syncMsg}
        where
        `id` = #{id} and
        `sync_status`=#{oldSyncStatus}
    </update>

    <!-- 更改同步状态,同步信息 -->
    <update id="updateSyncStatusAndMsg">
        update `erp_goods_batch_flow` set
        `sync_status` = #{syncStatus},
        `sync_msg`=#{syncMsg},
        `sync_time`=Now(),
        `update_count`=`update_count`+1
        where `id` = #{id}
    </update>

    <!-- 更改同步状态,重新同步 -->
    <update id="retryGoodsBatchFlow">
        update `erp_goods_batch_flow` set
        `sync_status` = 0,
        `sync_msg`=#{syncMsg},
        `sync_time`=Now(),
        `update_count`=`update_count`+1,
        failed_count=failed_count+1
        where `id` = #{id}
    </update>

    <select id="findByGInSnAndExcludeOperType" resultMap="BaseResultMap">
        <include refid="Base_Column_List"/>
        from `erp_goods_batch_flow`
        where `su_id` =#{suId} and in_sn=#{inSn}
        <if test="suDeptNo!=null and suDeptNo!=''">
            and su_dept_no=#{suDeptNo}
        </if>
    </select>

    <select id="syncGoodsBatchFlow" resultMap="BaseResultMap">
        <include refid="Base_Column_List"/>
        FROM erp_goods_batch_flow t
        WHERE t.sync_status = 0
        AND (t.su_id, t.su_dept_no) IN (
        SELECT
        c.su_id,
        c.su_dept_no
        FROM
        erp_client c
        WHERE
        c.client_status = 1
        AND c.sync_status = 1) limit 1000
    </select>

    <update id="updateOperTypeGoodsBatchFlowBySuId">
        update `erp_goods_batch_flow` set
        `edit_time` = NOW(),
        `sync_status` = 0,
        `oper_type` = 3,
         failed_count=0
        where `su_id` = #{suId}
    </update>

    <delete id="deleteGoodsBatchFlowBySuId">
        delete from erp_goods_batch_flow where su_id=#{suId}
        <if test="createTime!=null">
            <![CDATA[ and add_time<#{createTime} ]]>
        </if>
    </delete>

    <delete id="deleteByOperTypeAndSyncStatusOrGbNumber">
        DELETE FROM erp_goods_batch_flow
        WHERE su_id = #{suId} AND ((oper_type = 3 AND sync_status = 2) OR gb_number = 0)
    </delete>

    <delete id="deleteByGbTimeEndAndOperTypeAndSyncStatus">
        DELETE FROM erp_goods_batch_flow
        WHERE su_id = #{suId} AND oper_type = 3 AND sync_status = 3 AND gb_time <![CDATA[ <= ]]> #{gbTimeEnd}
    </delete>

</mapper>
