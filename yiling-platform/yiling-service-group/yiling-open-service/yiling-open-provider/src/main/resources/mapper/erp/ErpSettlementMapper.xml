<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yiling.open.erp.dao.ErpSettlementMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.yiling.open.erp.entity.ErpSettlementDO">
        <result column="id" property="id" />
        <result column="erp_charge_id" property="erpChargeId" />
        <result column="su_id" property="suId" />
        <result column="su_dept_no" property="suDeptNo" />
        <result column="charge_no" property="chargeNo" />
        <result column="charge_off_type" property="chargeOffType" />
        <result column="charge_off_no" property="chargeOffNo" />
        <result column="charge_off_amount" property="chargeOffAmount" />
        <result column="charge_time" property="chargeTime" />
        <result column="goods_in_sn" property="goodsInSn" />
        <result column="return_type" property="returnType"/>
        <result column="data_md5" property="dataMd5" />
        <result column="add_time" property="addTime" />
        <result column="edit_time" property="editTime" />
        <result column="oper_type" property="operType" />
        <result column="sync_status" property="syncStatus" />
        <result column="sync_time" property="syncTime" />
        <result column="sync_msg" property="syncMsg" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
       select id,
        erp_charge_id, su_id, su_dept_no, charge_no, charge_off_type, charge_off_no, charge_off_amount, charge_time, goods_in_sn,return_type, data_md5, add_time, edit_time, oper_type, sync_status, sync_time, sync_msg
    </sql>

    <select id="queryBySuIdAndSuDeptNo" resultMap="BaseResultMap">
        SELECT id,su_id,su_dept_no,erp_charge_id,data_md5,oper_type FROM erp_settlement WHERE su_id = #{suId}
        <if test="suDeptNo != null and suDeptNo != ''">
            AND su_dept_no = #{suDeptNo}
        </if>
        LIMIT #{start},#{count}
    </select>

    <select id="queryHistoryList" resultMap="BaseResultMap">
        SELECT id,su_id,su_dept_no,erp_charge_id,oper_type
        FROM erp_settlement
        WHERE su_id = #{suId}
        <if test="suDeptNoSet != null and suDeptNoSet.size() > 0">
            AND su_dept_no IN
            <foreach item="item" index="index" collection="suDeptNoSet"
                     open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="erpPrimaryKeySet != null and erpPrimaryKeySet.size() > 0">
            AND erp_charge_id IN
            <foreach item="item" index="index" collection="erpPrimaryKeySet"
                     open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </select>

    <insert id="batchInsert" parameterType="com.yiling.open.erp.entity.ErpSettlementDO" useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO erp_settlement (
        id,
        su_id,
        su_dept_no,
        erp_charge_id,
        charge_no,
        charge_off_type,
        charge_off_no,
        charge_off_amount,
        charge_time,
        goods_in_sn,
        return_type,
        data_md5,
        add_time,
        oper_type,
        sync_status,
        sync_msg
        )
        VALUES
        <foreach collection="list" item="item" index="index"
                 separator=",">
            (
            #{item.id},
            #{item.suId},
            #{item.suDeptNo},
            #{item.erpChargeId},
            #{item.chargeNo},
            #{item.chargeOffType},
            #{item.chargeOffNo},
            #{item.chargeOffAmount},
            #{item.chargeTime},
            #{item.goodsInSn},
            #{item.returnType},
            #{item.dataMd5},
            NOW(),
            1,
            1,
            #{item.syncMsg}
            )
        </foreach>
    </insert>

    <update id="updateByPrimaryKey" parameterType="com.yiling.open.erp.entity.ErpSettlementDO">
        UPDATE erp_settlement
        SET
        <if test="suId != null">
            `su_id` = #{suId},
        </if>
        <if test="suDeptNo != null and suDeptNo != ''">
            `su_dept_no` = #{suDeptNo},
        </if>
        <if test="erpChargeId != null and erpChargeId != ''">
            `erp_charge_id` = #{erpChargeId},
        </if>
        <if test="chargeNo != null and chargeNo != ''">
            `charge_no` = #{chargeNo},
        </if>
        <if test="chargeOffType != null and chargeOffType != ''">
            `charge_off_type` = #{chargeOffType},
        </if>
        <if test="chargeOffNo != null and chargeOffNo != ''">
            `charge_off_no` = #{chargeOffNo},
        </if>
        <if test="goodsInSn != null and goodsInSn != ''">
            `goods_in_sn` = #{goodsInSn},
        </if>
        <if test="goodsInSn != null and goodsInSn != ''">
            `goods_in_sn` = #{goodsInSn},
        </if>
        <if test="chargeTime != null ">
            `charge_time` = #{chargeTime},
        </if>
        <if test="returnType != null and returnType != ''">
            `return_type` = #{returnType},
        </if>
        <if test="dataMd5 != null and dataMd5 != ''">
            `data_md5` = #{dataMd5},
        </if>
        <if test="syncMsg != null and syncMsg != ''">
            `sync_msg` = #{syncMsg},
        </if>
        <if test="syncStatus != null">
            `sync_status` = #{syncStatus},
        </if>
        `edit_time` = NOW(),
        `oper_type` = 2
        WHERE id = #{id}
    </update>

    <update id="updateSyncInfoByPrimaryKey" parameterType="com.yiling.open.erp.entity.ErpSettlementDO">
        UPDATE erp_settlement
        SET
        `sync_status` = #{syncStatus},
        `sync_msg` = #{syncMsg}
        WHERE id = #{id}
    </update>

    <update id="deleteByPrimaryKey" parameterType="com.yiling.open.erp.entity.ErpSettlementDO">
        UPDATE erp_settlement
        SET
        `edit_time` = NOW(),
        `oper_type` = 3,
        `sync_status` = #{syncStatus},
        `sync_msg` = #{syncMsg}
        WHERE `id` = #{id}
        AND oper_type &lt; 3
    </update>

    <update id="deleteByPrimaryKeys">
        UPDATE erp_settlement
        SET
        `edit_time` = NOW(),
        `oper_type` = 3,
        `sync_status` = 1
        WHERE id IN
        <foreach item="item" index="index" collection="list" open="("
                 separator="," close=")">
            #{item}
        </foreach>
    </update>

    <!--=================================================================================================-->
    <update id="updateSyncStatusByStatusAndId">
        update
        `erp_settlement` set
        `sync_status`=#{syncStatus},`sync_time`=Now(),`sync_msg` = #{syncMsg}
        where
        `id` = #{id} and
        `sync_status`=#{oldSyncStatus}
    </update>


    <!-- 更改同步状态,同步信息 -->
    <update id="updateSyncStatusAndMsg">
        update `erp_settlement` set
        `sync_status` = #{syncStatus},
        `sync_msg`=#{syncMsg},
        `sync_time`=Now()
        where `id` = #{id}
    </update>


    <select id="syncSettlement" resultMap="BaseResultMap">
        <include refid="Base_Column_List"/>
        FROM erp_settlement t
        WHERE t.sync_status = 0
        AND (t.su_id, t.su_dept_no) IN (
        SELECT
        c.su_id,
        c.su_dept_no
        FROM
        erp_client c
        WHERE
        c.client_status = 1
        AND c.sync_status = 1) LIMIT 1000
    </select>

</mapper>
