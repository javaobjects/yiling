<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yiling.dataflow.order.dao.FlowShopSaleMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.yiling.dataflow.order.entity.FlowShopSaleDO">
    <result column="id" property="id" />
        <result column="eid" property="eid" />
        <result column="ename" property="ename" />
        <result column="crm_enterprise_id" property="crmEnterpriseId" />
        <result column="crm_code" property="crmCode" />
        <result column="shop_eid" property="shopEid" />
        <result column="shop_ename" property="shopEname" />
        <result column="shop_no" property="shopNo" />
        <result column="so_id" property="soId" />
        <result column="so_no" property="soNo" />
        <result column="license_number" property="licenseNumber" />
        <result column="so_time" property="soTime" />
        <result column="so_month" property="soMonth" />
        <result column="order_time" property="orderTime" />
        <result column="goods_in_sn" property="goodsInSn" />
        <result column="goods_name" property="goodsName" />
        <result column="so_specifications" property="soSpecifications" />
        <result column="specification_id" property="specificationId" />
        <result column="so_batch_no" property="soBatchNo" />
        <result column="so_product_time" property="soProductTime" />
        <result column="so_effective_time" property="soEffectiveTime" />
        <result column="so_quantity" property="soQuantity" />
        <result column="so_unit" property="soUnit" />
        <result column="so_price" property="soPrice" />
        <result column="so_total_amount" property="soTotalAmount" />
        <result column="so_manufacturer" property="soManufacturer" />
        <result column="so_license" property="soLicense" />
        <result column="province_code" property="provinceCode" />
        <result column="province_name" property="provinceName" />
        <result column="city_code" property="cityCode" />
        <result column="city_name" property="cityName" />
        <result column="region_code" property="regionCode" />
        <result column="region_name" property="regionName" />
        <result column="crm_goods_code" property="crmGoodsCode" />
        <result column="goods_possible_error" property="goodsPossibleError" />
        <result column="report_sync_status" property="reportSyncStatus" />
        <result column="customer_type_name" property="customerTypeName" />
        <result column="belong_department" property="belongDepartment" />
        <result column="lock_type" property="lockType" />
        <result column="data_tag" property="dataTag" />
        <result column="del_flag" property="delFlag" />
        <result column="create_user" property="createUser" />
        <result column="create_time" property="createTime" />
        <result column="update_user" property="updateUser" />
        <result column="update_time" property="updateTime" />
        <result column="remark" property="remark" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id,
        eid, ename, crm_enterprise_id, crm_code, shop_eid, shop_ename, shop_no, so_id, so_no, license_number, so_time, so_month, order_time, goods_in_sn, goods_name, so_specifications, specification_id, so_batch_no, so_product_time, so_effective_time, so_quantity, so_unit, so_price, so_total_amount, so_manufacturer, so_license, province_code, province_name, city_code, city_name, region_code, region_name, crm_goods_code, goods_possible_error, report_sync_status, customer_type_name, belong_department, lock_type, data_tag, del_flag, create_user, create_time, update_user, update_time, remark
    </sql>

    <select id="page" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        `flow_shop_sale`
        <where>
            del_flag = 0
            <if test="request.eid != null and request.eid != 0">
                AND eid=#{request.eid,jdbcType=BIGINT}
            </if>
            <if test="request.shopEid != null and request.shopEid != 0">
                AND shop_eid=#{request.shopEid,jdbcType=BIGINT}
            </if>
            <if test="request.goodsName != null and request.goodsName != ''">
                AND goods_name like concat('%',#{request.goodsName},'%')
            </if>
            <if test="request.license != null and request.license != ''">
                AND so_license like concat('%',#{request.license},'%')
            </if>
            <if test="request.manufacturer != null and request.manufacturer != ''">
                AND so_manufacturer like concat('%',#{request.manufacturer},'%')
            </if>
            <if test="request.startTime != null">
                AND so_time <![CDATA[ >= ]]> #{request.startTime}
            </if>
            <if test="request.endTime != null">
                AND so_time <![CDATA[ <= ]]> #{request.endTime}
            </if>
            <if test="request.month != null and request.month != ''">
                AND so_month <![CDATA[ = ]]> #{request.month}
            </if>
            <if test="request.idList != null and request.idList.size() > 0">
                AND id in
                <foreach item="item" index="index" collection="request.idList" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="request.eidList != null and request.eidList.size() > 0">
                AND eid in
                <foreach item="item" index="index" collection="request.eidList" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="request.shopEidList != null and request.shopEidList.size() > 0">
                AND shop_eid in
                <foreach item="item" index="index" collection="request.shopEidList" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>

    <update id="deleteFlowShopSaleBydEidAndSoTime">
        UPDATE flow_shop_sale
        SET del_flag = 1, update_time = NOW(), remark = '连锁纯销流向解封删除，再重新同步此月份'
        WHERE  del_flag = 0
        AND eid = #{request.eid}
        AND (so_time BETWEEN #{request.startMonth} AND #{request.endMonth})
    </update>

</mapper>
